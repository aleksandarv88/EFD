============================================================
EFD: ONSET OF DYNAMICS â€” STAGE 4 (v3.2)
ENERGY & BALANCE LAWS FROM COHERENCE
============================================================

## PURPOSE
Define energy purely from Stage 1â€“3 primitives (C, Îµ*, âˆ‚M, R, U_X, d_X)
and derive balance laws. Core principle: energy is the observerâ€™s
equilibrium coherence determined by the boundary condition. Internal
re-coherence moves the state to that equilibrium; it neither creates nor
destroys energy. Only boundary updates change energy.

No external clocks, units, or symplectic structures are introduced.

------------------------------------------------------------
0) IMPORTS (Stage 1 v3.4; Stage 2 v3.3; Stage 3 v3.1)
------------------------------------------------------------
â€¢ C : coherence functional; Îµ* : Ï„-plateau threshold; Î  : boundary projection
â€¢ R : least-fixed-point re-coherence operator (level-synchronous by SCC)
â€¢ U_X, w_{ij}, d_X : snapshot geometry; used for flows/visualization
â€¢ Time Ï„ : round index from Stage 2 (unit-less)

Notation:
  X          â€“ current internal state on closure M_â„“
  B âŠ‚ M_â„“    â€“ finite interface (observer boundary)
  b          â€“ boundary condition on B (Def. 1.1)
  X^*(b)     â€“ least fixed point of R given b
  C^*(b)     â€“ shorthand for C( X^*(b) )

============================================================
1) ENERGY AS EQUILIBRIUM COHERENCE
============================================================
Definition 1.1 (Boundary state).
Let Î : âˆ‚M â†’ B project boundary flicker onto the interface B âŠ‚ M_â„“.
The boundary condition is the finite tuple
  b := { (p, Ï‡_p) }_{pâˆˆB},
where each Ï‡_p is the *admissible boundary constraint* inherited at site p.
Concretely, Ï‡_p can be: a fixed label/value, a finite allowed set of labels,
or a local predicate over the relation at pâ€”exactly as induced by Î .
All equilibrium objects X^*(b), C^*(b) are defined relative to this b.

Definition 1.2 (Equilibrium map and energy).
Given b, let X^*(b) be the least fixed point of R under b (Stage 1).
Define the **energy** of the observer at boundary b as
  E(b) := C( X^*(b) ) =: C^*(b).

Remarks.
â€¢ E depends only on (C, R) and b; it is **independent** of any intermediate
  internal states X on the way to X^*(b).
â€¢ Îµ* is not a scale here; it already shapes R/scheduling and influences.

============================================================
2) FIRST LAW (EXACT BALANCE)
============================================================
Lemma 2.1 (Internal invariance).
Fix b. For any internal trajectory X â†’ â€¦ â†’ X^*(b) produced by R,
E(b) = C( X^*(b) ) is constant and independent of the path. Thus while b
is fixed, â€œenergyâ€ does not change over Ï„.

Definition 2.2 (Boundary work).
A boundary update b â†’ bâ€² (caused by Î (r) at âˆ‚M) performs **work**
  W(bâ†’bâ€²) := C( X^*(bâ€²) ) âˆ’ C( X^*(b) ) = E(bâ€²) âˆ’ E(b).

Theorem 2.3 (First Law â€” exact).
Let b_k be the boundary at round k, and X_k^* := X^*(b_k).
Then
  E(b_{k+1}) âˆ’ E(b_k) = W(b_kâ†’b_{k+1}).
Internal re-coherence between b_k and b_{k+1} does not contribute.

Corollary 2.4 (Closed observer).
If the boundary is static (b_{k+1}=b_k), then E is **conserved**:
E(b_{k+1}) âˆ’ E(b_k) = 0.

Interpretation.
Energy is an attribute of the **equilibrium** determined by b. Internal time
(ordered re-coherence) only resolves to that equilibrium.

============================================================
3) LOCAL ENERGY DENSITIES (CANONICAL PARTITIONS)
============================================================
We keep a global definition E(b) but provide emergent local partitions.

3.1 Edgeâ€“half visualization (default + optional variants).
At equilibrium X^*(b) build U := U_{X^*(b)} (Stage 3).

â€” **Default canonical (unweighted):**
   e_edge(i,j) := 1_{ {J_{ij} > Îµ*} },      e_node(i) := Â½ Î£_{jâˆˆN(i)} e_edge(i,j),
   E_half(b) := Î£_i e_node(i) = Î£_{ {i,j}âˆˆE(U) } e_edge(i,j).

â€” **Optional Îµ*-scaled display (threshold-scale):**
   e_edge^{(Îµ)}(i,j) := Îµ* Â· 1_{ {J_{ij} > Îµ*} }.

â€” **Optional Î”C-weighted local response:**
   choose a finite atomic-edit basis ğ’œ_i^basis âŠ‚ ğ’œ_i by either
   (i) *minimal generating set* of atomic edits at i; or
   (ii) *topâ€“K edits by |Î”C_i(Ïƒ)|* (small K, e.g., 3â€“5).
   Then
     e_edge^{(Î”C)}(i,j) := ğ”¼_{Ïƒâˆˆğ’œ_i^basis}[ |Î”C_j( T_{iâ†’j}(Ïƒ) )| ].
These are **visualization densities**; they need not sum exactly to E(b).
Use them for geometry-aware displays; use 3.2 for exact additivity.

3.2 Exact fixed-point contribution partition (SCC MÃ¶bius).
Let ğ’« be the SCC-condensation poset (Stage 1). We seek e_i^*(b) with
E(b) = Î£_{iâˆˆğ’«} e_i^*(b), uniquely determined by ğ’« and C at X^*(b).
For each xâˆˆğ’« let the principal ideal â†“x = { yâˆˆğ’« : y â‰¤ x } and define
  g(x) := C( X^*(b) |_{â†“x} ),
the coherence of the induced subproblem on â†“x with inherited boundary
(neighbors outside â†“x clamped to X^*(b)). There exists f on ğ’« such that
  g(x) = Î£_{yâ‰¤x} f(y).
The poset MÃ¶bius inversion yields
  e_x^*(b) := f(x) = Î£_{yâ‰¤x} Î¼_ğ’«(y,x) Â· g(y),
with Î¼_ğ’« the MÃ¶bius function of ğ’«. Then E(b) = Î£_{xâˆˆğ’«} e_x^*(b).
This decomposition is **unique** and isomorphism-invariant.

3.3 Computing e_i^* on the SCC poset (finite + large-case note).
Finite ğ’«: topologically sort ğ’«. For each x in order, compute g(x) by solving
the induced subproblem on â†“x (neighbors clamped). Compute Î¼_ğ’« via standard
DP on the incidence algebra (Î¼(x,x)=1; Î¼(y,x)=âˆ’Î£_{yâ‰¤z<x} Î¼(y,z)).
Then e_x^* = Î£_{yâ‰¤x} Î¼(y,x) g(y).

Large ğ’« (approximation): restrict to *local ideals of bounded depth* r around x
(e.g., r=1â€“2) with caching; this yields e_x^{*(r)} that converges monotonically
as r grows. Ordinal/well-founded extensions are deferred to Stage 5.

Remarks.
Use e_i^* when an exact additive match to E(b) is required; use the edgeâ€“half
variants for cheap geometric visualization.

============================================================
4) DISCRETE CONTINUITY (EXISTENCE OF FLOWS)
============================================================
We express local changes between equilibria as a divergence of edge flows.

Setup 4.0 (Two equilibria).
Consider b â†’ bâ€² with equilibria X^* := X^*(b), X^{*â€²} := X^*(bâ€²).
Let Uâ‚€ := U_{X^*}, Uâ‚ := U_{X^{*â€²}}, and Î“ be any connected component of Uâ‚€ âˆª Uâ‚.
Let e_i := e_i^*(b), e_iâ€² := e_i^*(bâ€²), and s_i := e_iâ€² âˆ’ e_i.
Trivially Î£_i s_i = E(bâ€²) âˆ’ E(b) = W(bâ†’bâ€²).

Theorem 4.1 (Flow representation on graphs).
On any connected graph Î“, for any node vector s with finite support,
there exists an antisymmetric edge flow J_{ij} = âˆ’J_{ji} such that
  (div J)_i := Î£_{jâˆˆN(i)} J_{ij} = s_i  for all iâˆˆÎ“.

Proof (constructive sketch).
Choose a spanning tree T of Î“, root r. Push s-mass from leaves to r, defining
J on tree edges; set J=0 on chords. Antisymmetry and divergence identities hold. âˆ

Corollary 4.2 (Discrete continuity).
For the boundary update bâ†’bâ€², there exists (generally non-unique) J on Î“
with  e_iâ€² âˆ’ e_i = (div J)_i, hence Î£_i (div J)_i = W(bâ†’bâ€²).
If bâ€²=b (closed observer), s=0 and there exists J with div J=0 (pure circulation).

4.3 Canonical minimal flow (unique, emergent; Thomson/Dirichlet).
To obtain a **unique** flow with a well-posed continuum limit, minimize
the strictly convex quadratic energy
  ğ“”(J) := Î£_{ {i,j}âˆˆE(Î“) } ( J_{ij}^2 / c_{ij} ),   subject to   div J = s,
with **conductances** c_{ij} := 1 / w_{ij} (Stage 3 weights).
This is the discrete Thomson/Dirichlet principle (minimal dissipation) on the
emergent conductance graph. The Eulerâ€“Lagrange equations give a node potential
Ï† solving the weighted graph Laplacian  L_c Ï† = s, and the unique minimizer
  J_{ij}^â€  = c_{ij} ( Ï†_i âˆ’ Ï†_j ).
All ingredients (w, hence c) are emergent from (C, Îµ*, X^*), so J^â€  is canonical.

============================================================
5) DYNAMICAL FLOWS ALONG TIME-RESPECTING PATHS
============================================================
When the boundary changes during a round, Stage-2 dynamics restrict actual
propagation to time-respecting paths.

Definition 5.1 (Round-k dynamic cone, recall).
Cone_dyn(S,k) (Stage 2) is the set of blocks reachable in â‰¤k hops along edges
present when predecessors resolve.

Proposition 5.2 (Causal compatibility).
For a single boundary pulse touching S at round 0 and no further changes,
there exists a choice of edge flow J^{(k)} each round such that:
  (i) support(J^{(k)}) âŠ† edges between Cone_dyn(S,k) and Cone_dyn(S,k+1),
  (ii) e^{(k+1)} âˆ’ e^{(k)} = div J^{(k)} on the active region,
  (iii) Î£_i e_i^{(k)} = E(b) is constant for fixed b.

Sketch.
Restrict the (tree-push or minimal) flow construction to the active frontier
each round; Stage-2 level-synchronous updates ensure â‰¤1 hop/round. âˆ

============================================================
6) WHEN IS TOTAL ENERGY CONSERVED?
============================================================
From Theorem 2.3:
â€” If b is static (closed observer), E(b) is conserved.
â€” If b changes, Î”E equals boundary work W(bâ†’bâ€²).

Definition 6.1 (Coherence-exchange symmetry).
C has coherence-exchange symmetry on M_â„“ if for every local re-coherence
update at fixed b the exact partition e^* (Sec. 3.2) satisfies
  Î”e_i^* + Î£_{jâˆˆN(i)} Î”e_j^* = 0.
Equivalently: internal updates only **redistribute** e^* between i and neighbors.

Theorem 6.2 (Conservation under exchange symmetry).
If C has coherence-exchange symmetry on M_â„“, then for fixed b and any internal
trajectory, E(b)=Î£_i e_i^*(b) is conserved **at every Ï„ sub-step**; moreover
there exists an antisymmetric J with div J=0 that realizes the local changes.

Remarks.
â€¢ Exchange symmetry holds e.g. when C decomposes at equilibrium as a sum of
pairwise symmetric edge potentials on U. When it fails, E(b) remains conserved
over rounds at fixed b (Lemma 2.1); sub-step redistribution may look
â€œdissipativeâ€ locally, but it is *exactly reabsorbed* when SCCs reach X^*(b).
No entropy primitive is introduced or required.

============================================================
7) EMERGENCE & INVARIANCE CHECK
============================================================
â€¢ No new primitives: E(b)=C(X^*(b)); exact partition via SCC-poset MÃ¶bius
  (unique on ğ’«); flows exist by graph combinatorics; minimal flow J^â€  uses
  only Stage-3 weights w (hence emergent).
â€¢ Observer invariance: Isomorphisms preserve b, C, U, hence E(b), e_i^*, and
  any induced flows up to relabeling.
â€¢ Plateau stability: On an Îµ* Ï„-plateau, U is stable; edge-half displays and
  causal cones are robust to boundary-scale flicker.

============================================================
8) EXAMPLES (ASCII)
============================================================
(1) Closed observer (static boundary)
  b fixed. System at X^*(b). E(b) constant; any intra-round â€œringingâ€ is
  redistribution (div-free circulation), decaying to X^*(b) with no Î”E.

(2) Single pulse on a chain (tiny numbers)
  Nodes: Aâ€”Bâ€”Câ€”D with weights w_AB=1, w_BC=2, w_CD=1 â‡’ conductances
  c_AB=1, c_BC=0.5, c_CD=1. Suppose e^* shifts s = (+1 at A, âˆ’1 at D).
  Solve L_c Ï† = s:
    (A)  c_AB(Ï†_Aâˆ’Ï†_B) = +1
    (B) âˆ’c_AB(Ï†_Aâˆ’Ï†_B) + c_BC(Ï†_Bâˆ’Ï†_C) = 0
    (C) âˆ’c_BC(Ï†_Bâˆ’Ï†_C) + c_CD(Ï†_Câˆ’Ï†_D) = 0
    (D) âˆ’c_CD(Ï†_Câˆ’Ï†_D) = âˆ’1
  Yields a unique Ï† (up to constant); minimal flow J^â€ _{ij} = c_{ij}(Ï†_iâˆ’Ï†_j).
  Support expands â‰¤1 hop/round; total Î”E = W(bâ†’bâ€²).

(3) Two pulses across a 4-cycle
  Pulses at opposite nodes of a square. s splits into two signed blobs.
  The minimal J^â€  circulates around the cycle before settling; Î”E = Wâ‚+Wâ‚‚.

============================================================
9) PSEUDOCODE (E, partitions, flows)
============================================================
# Energy at a boundary b
X_star = LeastFixedPoint_R(b)                  # Stage 1
E = C(X_star)

# Exact partition via SCC-poset MÃ¶bius (finite case)
P = SCC_Condensation_Poset(X_star)             # Stage 1
g[x] = CoherenceOfInducedSubproblem(X_star, ideal=Downset(x))
mu = MobiusFunction(P)                         # DP on incidence algebra
for x in TopoOrder(P):
    e_star[x] = sum( mu[y,x] * g[y] for y<=x ) # e_x^*
assert sum(e_star.values()) == E

# Edgeâ€“half visualization (default canonical)
U = Build_U(X_star)                            # Stage 3
for i: e_node[i] = 0
for each edge {i,j} in U:
    e_edge = 1
    e_node[i] += 0.5 * e_edge
    e_node[j] += 0.5 * e_edge

# Optional Î”C-weighted basis selection
for i:
    A_basis[i] = MinimalGeneratingEdits(i)      # or TopKByAbsDeltaC(i, K=3)

# Minimal (unique) flow between equilibria b -> b'
X0, X1 = LeastFixedPoint_R(b), LeastFixedPoint_R(b')
e0, e1 = MobiusDecompose(C, X0, P), MobiusDecompose(C, X1, P)
s[i] = e1[i] - e0[i]
U_union = UnionGraphs(Build_U(X0), Build_U(X1))
c_ij = {edge: 1.0 / w_ij(edge, X0 or X1)}      # conductance from Stage 3

# Solve L_c phi = s  (SPD; Conjugate Gradient works well with Jacobi precond)
phi = ConjugateGradient_Laplacian(U_union, c_ij, s)

for edge {i,j} in U_union:
    J_min[ij] = c_ij[{i,j}] * (phi[i] - phi[j])  # antisymmetric by construction

# Optional: enforce causality per round using Stage-2 cones
for k in 0..tau:
    restrict J_min^(k) to edges between Cone_dyn(S,k) and Cone_dyn(S,k+1)

# Notes:
# â€¢ W1 (Ollivier) in Stage 3 can use EMD/Hungarian on small neighborhoods.
# â€¢ Cache g(Â·) over local ideals to scale MÃ¶bius on large posets.

============================================================
10) RESULTS
============================================================
â€¢ Energy E(b) = C(X^*(b)) derived with no extra structure.
â€¢ First Law (exact): Î”E equals boundary work; closed observers conserve E.
â€¢ Canonical local partitions exist:
  â€” exact via SCC-poset MÃ¶bius inversion (unique, additive),
  â€” geometric displays via edgeâ€“half / Îµ*-scaled / Î”C-weighted (emergent).
â€¢ Discrete continuity: any Î”e between equilibria = div J on U; a **unique**
  canonical flow J^â€  arises by minimal dissipation w.r.t. Stage-3 weights;
  causal flows can be chosen round-by-round to respect Stage-2 cones.

============================================================
11) FORESHADOW (to Stage 5/6)
============================================================
â€¢ Stage 5 (continuum): prove Î“-convergence of E-partitions to energy densities
  and convergence of discrete minimal flows J^â€  to vector fields with âˆ‡Â·J = âˆ‚_t Ï.
â€¢ Symmetries for Noether-style results: a **C-invariance** is an automorphism
  of the closure (graph and labels) that leaves C unchanged. Stage 6 will map
  such invariances to conserved currents; exchange symmetry is the local case.

============================================================
End of Stage 4 (v3.2)
============================================================
